name: Build iOS IPA

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Briefcase and dependencies
      run: |
        python -m pip install --upgrade pip
        pip install briefcase toga-iOS
    
    - name: Verify installations
      run: |
        python --version
        briefcase --version
        echo "Current directory: $(pwd)"
        echo "Files in project:"
        ls -la
        echo "pyproject.toml content:"
        cat pyproject.toml || echo "pyproject.toml not found"
    
    - name: Create iOS app
      run: |
        briefcase create iOS --no-input || {
          echo "Create failed, checking for existing iOS directory..."
          ls -la iOS/ || echo "iOS directory does not exist"
          exit 1
        }
    
    - name: Build iOS app
      run: |
        briefcase build iOS --no-input || {
          echo "Build failed, checking iOS directory..."
          ls -la iOS/ || echo "iOS directory does not exist"
          exit 1
        }
    
    - name: Package iOS app (unsigned IPA)
      run: |
        briefcase package iOS --unsign --no-input || {
          echo "Package failed, checking for IPA files..."
          find . -name "*.ipa" -type f || echo "No IPA files found"
          exit 1
        }
    
    - name: Find IPA file
      id: find_ipa
      run: |
        IPA_PATH=$(find . -name "*.ipa" -type f | head -n 1)
        echo "ipa_path=$IPA_PATH" >> $GITHUB_OUTPUT
        echo "Found IPA: $IPA_PATH"
    
    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: creatine-water-reminder-ipa
        path: ${{ steps.find_ipa.outputs.ipa_path }}
        retention-days: 30

