name: Build iOS IPA

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Briefcase and dependencies
      run: |
        python -m pip install --upgrade pip
        pip install briefcase toga-iOS
    
    - name: Verify installations
      run: |
        python --version
        briefcase --version
        echo "Current directory: $(pwd)"
        echo "Files in project:"
        ls -la
        echo "pyproject.toml content:"
        cat pyproject.toml || echo "pyproject.toml not found"
    
    - name: Create iOS app
      run: |
        echo "Creating iOS app..."
        export PYTHONPATH="${PYTHONPATH}:$(pwd)/src"
        briefcase create iOS || echo "Create command completed with status $?"
        echo "Checking iOS directory..."
        ls -la iOS/ 2>/dev/null || echo "iOS directory not found"
    
    - name: Build iOS app
      run: |
        echo "Building iOS app..."
        export PYTHONPATH="${PYTHONPATH}:$(pwd)/src"
        briefcase build iOS || echo "Build command completed with status $?"
        echo "Checking build output..."
        find iOS -name "*.app" -type d 2>/dev/null || echo "No .app found"
    
    - name: Package iOS app (unsigned IPA)
      run: |
        echo "Packaging iOS app..."
        export PYTHONPATH="${PYTHONPATH}:$(pwd)/src"
        
        # Önce mevcut durumu kontrol et
        echo "Checking iOS directory before package:"
        find iOS -type f -o -type d | head -20
        
        # Xcode projesinde imza ayarlarını devre dışı bırak
        if [ -f "iOS/CreatineWaterReminder/CreatineWaterReminder.xcodeproj/project.pbxproj" ]; then
          echo "Modifying Xcode project to disable code signing..."
          sed -i '' 's/CODE_SIGN_IDENTITY = "[^"]*"/CODE_SIGN_IDENTITY = ""/g' iOS/CreatineWaterReminder/CreatineWaterReminder.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGNING_REQUIRED = YES/CODE_SIGNING_REQUIRED = NO/g' iOS/CreatineWaterReminder/CreatineWaterReminder.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGNING_ALLOWED = YES/CODE_SIGNING_ALLOWED = NO/g' iOS/CreatineWaterReminder/CreatineWaterReminder.xcodeproj/project.pbxproj
        else
          echo "Xcode project file not found at expected location"
          echo "Searching for Xcode project:"
          find iOS -name "*.xcodeproj" -o -name "*.xcworkspace" 2>/dev/null || echo "No Xcode project found"
        fi
        
        # Briefcase package komutu
        echo "Running briefcase package iOS..."
        briefcase package iOS 2>&1 || {
          PACKAGE_STATUS=$?
          echo "Briefcase package exited with status: $PACKAGE_STATUS"
        }
        
        # Package sonrası durumu kontrol et
        echo "Checking iOS directory after package:"
        find iOS -type f -o -type d | head -30
        
        # .app dosyasını ara
        echo "Searching for .app file..."
        APP_PATH=$(find . -name "*.app" -type d | head -n 1)
        if [ -n "$APP_PATH" ]; then
          echo "Found .app at: $APP_PATH"
          echo "Creating IPA manually from .app..."
          APP_NAME=$(basename "$APP_PATH" .app)
          IPA_NAME="${APP_NAME}.ipa"
          # Payload klasörü oluştur ve .app'i kopyala
          mkdir -p Payload
          cp -r "$APP_PATH" Payload/
          # IPA oluştur
          zip -r "$IPA_NAME" Payload
          echo "IPA created: $IPA_NAME"
          ls -lh "$IPA_NAME"
          # Payload klasörünü temizle
          rm -rf Payload
        else
          echo "No .app file found anywhere!"
          echo "Searching in build directory:"
          find build -type f -o -type d 2>/dev/null | head -20 || echo "No build directory"
        fi
    
    - name: Find IPA file
      id: find_ipa
      run: |
        echo "Searching for IPA files..."
        # Önce root'ta ara (manuel oluşturduğumuz IPA)
        IPA_PATH=$(find . -maxdepth 1 -name "*.ipa" -type f | head -n 1)
        if [ -z "$IPA_PATH" ]; then
          # Sonra tüm klasörlerde ara
          IPA_PATH=$(find . -name "*.ipa" -type f | head -n 1)
        fi
        if [ -z "$IPA_PATH" ]; then
          # iOS klasöründe ara
          IPA_PATH=$(find iOS -name "*.ipa" -type f | head -n 1)
        fi
        if [ -n "$IPA_PATH" ]; then
          echo "ipa_path=$IPA_PATH" >> $GITHUB_OUTPUT
          echo "Found IPA: $IPA_PATH"
          ls -lh "$IPA_PATH"
        else
          echo "ERROR: No IPA file found!"
          echo "Listing all files in project root:"
          ls -la
          echo "Listing iOS directory:"
          find iOS -type f -o -type d | head -20
          exit 1
        fi
    
    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: creatine-water-reminder-ipa
        path: ${{ steps.find_ipa.outputs.ipa_path }}
        retention-days: 30
        if-no-files-found: error

