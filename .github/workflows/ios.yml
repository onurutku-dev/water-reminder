name: Build iOS IPA

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Briefcase and dependencies
      run: |
        python -m pip install --upgrade pip
        pip install briefcase toga-iOS
    
    - name: Verify installations
      run: |
        python --version
        briefcase --version
        echo "Current directory: $(pwd)"
        echo "Files in project:"
        ls -la
        echo "pyproject.toml content:"
        cat pyproject.toml || echo "pyproject.toml not found"
    
    - name: Create iOS app
      run: |
        echo "Creating iOS app..."
        export PYTHONPATH="${PYTHONPATH}:$(pwd)/src"
        briefcase create iOS || echo "Create command completed with status $?"
        echo "Checking iOS directory..."
        ls -la iOS/ 2>/dev/null || echo "iOS directory not found"
    
    - name: Build iOS app
      run: |
        echo "Building iOS app..."
        export PYTHONPATH="${PYTHONPATH}:$(pwd)/src"
        briefcase build iOS || echo "Build command completed with status $?"
        echo "Checking build output..."
        find iOS -name "*.app" -type d 2>/dev/null || echo "No .app found"
    
    - name: Package iOS app (unsigned IPA)
      run: |
        echo "Packaging iOS app..."
        export PYTHONPATH="${PYTHONPATH}:$(pwd)/src"
        # Briefcase package komutu (--unsign parametresi yok)
        # Önce Xcode projesinde imza ayarlarını kontrol et ve gerekirse devre dışı bırak
        if [ -f "iOS/CreatineWaterReminder/CreatineWaterReminder.xcodeproj/project.pbxproj" ]; then
          echo "Modifying Xcode project to disable code signing..."
          # macOS sed syntax
          sed -i '' 's/CODE_SIGN_IDENTITY = "[^"]*"/CODE_SIGN_IDENTITY = ""/g' iOS/CreatineWaterReminder/CreatineWaterReminder.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGNING_REQUIRED = YES/CODE_SIGNING_REQUIRED = NO/g' iOS/CreatineWaterReminder/CreatineWaterReminder.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGNING_ALLOWED = YES/CODE_SIGNING_ALLOWED = NO/g' iOS/CreatineWaterReminder/CreatineWaterReminder.xcodeproj/project.pbxproj
        fi
        # Briefcase package komutu
        briefcase package iOS
    
    - name: Find IPA file
      id: find_ipa
      run: |
        IPA_PATH=$(find . -name "*.ipa" -type f | head -n 1)
        echo "ipa_path=$IPA_PATH" >> $GITHUB_OUTPUT
        echo "Found IPA: $IPA_PATH"
    
    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: creatine-water-reminder-ipa
        path: ${{ steps.find_ipa.outputs.ipa_path }}
        retention-days: 30

